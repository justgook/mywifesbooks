---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BookGrid from '../../components/BookGrid.astro';
import { getCollection } from 'astro:content';
import createSlug from "../../lib/createSlug";

export async function getStaticPaths() {
  const books = await getCollection('books');
  // Split authors by comma and create slugs for each
  const allAuthors = books.flatMap(book => 
    book.data.author.split(',').map((author: string) => author.trim())
  );
  const tagsSet = new Set(allAuthors.map(author => createSlug(author)));
  tagsSet.delete("");
  const tags = [...tagsSet];
  return tags.map(author => ({
    params: { author },
    props: { author }
  }));
}

const { author } = Astro.params;
let title = author;
const books = await getCollection('books').then(books => 
  books.filter(book => {
    // Split authors by comma and check if any match the slug
    const authors = book.data.author.split(',').map((a: string) => a.trim());
    const matchingAuthor = authors.find((a: string) => createSlug(a) === author);
    if (matchingAuthor) {
      title = matchingAuthor;
      return true;
    }
    return false;
  })
);
---

<BaseLayout title={title}>
  <h1 class="text-3xl font-bold mb-8">{title}</h1>
  <BookGrid books={books} />
</BaseLayout>
